<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<title>Codurance - Google+ Sign-In with Scalatra</title>

<!-- Meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- CSS Global Compulsory-->
<link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/responsive.css">
<link rel="stylesheet" href="/assets/css/headers/header1.css">
<link rel="stylesheet" href="/assets/css/pages/page_one.css">
<!-- CSS Implementing Plugins -->
<link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.css">
<link rel="stylesheet" href="/assets/plugins/flexslider/flexslider.css">
<link rel="stylesheet" href="/assets/plugins/parallax-slider/css/parallax-slider.css">
<link rel="stylesheet" href="/assets/css/pages/portfolio-v1.css">
<link rel="stylesheet" href="assets/css/pages/page_404_error.css">
<link rel="stylesheet" href="/assets/css/syntax.css">
<!-- CSS Theme -->
<link rel="stylesheet" href="/assets/css/themes/orange.css" id="style_color">
<link rel="stylesheet" href="/assets/css/themes/headers/header1-orange.css" id="style_color-header-1">
<!-- Custom -->
<link rel="stylesheet" href="/assets/css/codurance/app.css">



<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46289079-1', 'codurance.com');
    ga('send', 'pageview');
</script>

</head>

<body>
<!--=== Header ===-->
<div class="header">
    <div class="navbar navbar-default" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">
                    <img id="logo-header" src="/assets/img/logo1-orange.png" height="45" alt="Logo">
                </a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-responsive-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/services">Services</a></li>
                    <li><a href="/casestudies">Case Studies</a></li>
                    <li><a href="/videos">Videos</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/careers/craftsman">Careers</a></li>
                    <li class="dropdown"><a class="dropdown-toggle" data-hover="dropdown" data-delay="0" data-close-others="false">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu">
                        <li><a href="/aboutus/ourteam">Our Team</a></li>
                        <li><a href="/aboutus/ourcompany">Our Company</a></li>
                        <li><a href="/aboutus/ourpractices">Our Practices</a></li>
                    </ul></li>
                </ul>
                <div class="search-open">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">
                            <button class="btn-u" type="button">Go</button>
                        </span>
                    </div><!-- /input-group -->
                </div>
            </div><!-- /navbar-collapse -->
        </div>
    </div>
</div><!--/header-->



<!--=== End Header ===-->


    <div class="breadcrumbs margin-bottom-10">
        <div class="container">
            <h2 class="pull-left">Google+ Sign-In with Scalatra</h2>
            <ul class="pull-right breadcrumb">
                <li><a href="/">Home</a></li>
                
                    <li>
                    
                        <a href="/blog">Blog</a>
                    
                    </li>
                
            </ul>
        </div>
    </div>



<div class="container">
<div class="row blog-page blog-item">
<!-- Left Sidebar -->
<div class="col-md-9 md-margin-bottom-60">
    <!--Blog Post-->
    <div class="blog margin-bottom-40">
        
        <div class="blog-post-tags">
            <ul class="list-unstyled list-inline blog-info">
                <li><i class="icon-calendar"></i> 10 Jul 2014</li>
                <li><i class="icon-pencil"></i> Sandro Mancuso</li>
            </ul>
        </div>
        

        <h3>The requirements</h3>

<p>For one of our internal pet-projects at Codurance, we decided to have authentication and authorisation using <a href="https://developers.google.com/+/">Google+ Sign-in</a>. Google+ Sign-In is able to authenticate anyone with a Google email account (gmail or business) using OAuth 2.0. However, we wanted to restrict the application to Codurance craftsmen only, that means, people with a Codurance email address.</p>

<p>The application had also to redirect us to the desired URL, in case we tried to access a deep URL without being authenticated.</p>

<h3>Technology stack</h3>

<p>In this project we are using:</p>

<ul>
<li><a href="http://www.scala-lang.org/">Scala</a></li>
<li><a href="http://www.scalatra.org/">Scalatra</a> as a web micro-framework</li>
<li><a href="http://jade-lang.com/">Jade</a> as template engine</li>
<li><a href="http://www.scala-sbt.org/">sbt</a> as our build tool.</li>
<li><a href="https://github.com/json4s/json4s">json4s</a> for JSON manipulation</li>
<li><a href="https://github.com/stackmob/newman">Newman</a> as HTTP client library</li>
</ul>


<h3>Implementation</h3>

<h4>Authentication Filter</h4>

<p>First we need to add an AuthenticationFilter to our Scalatra application.</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">javax.servlet.ServletContext</span>

<span class="k">import</span> <span class="nn">com.codurance.cerebro.controllers.MainController</span>
<span class="k">import</span> <span class="nn">com.codurance.cerebro.security.AuthenticationFilter</span>
<span class="k">import</span> <span class="nn">org.scalatra._</span>

<span class="k">class</span> <span class="nc">ScalatraBootstrap</span> <span class="k">extends</span> <span class="nc">LifeCycle</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">init</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ServletContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">mount</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationFilter</span><span class="o">,</span> <span class="s">&quot;/*&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">mount</span><span class="o">(</span><span class="k">new</span> <span class="nc">MainController</span><span class="o">,</span> <span class="s">&quot;/*&quot;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>Then, in the AuthenticationFilter, we need to redirect to the sign-in page when we don't have a user in the session. We also need to exclude the pages and URLs that don't need a user to be logged in.</p>

<div class="highlight"><pre><code class="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.security</span>

<span class="k">import</span> <span class="nn">org.scalatra.ScalatraFilter</span>

<span class="k">class</span> <span class="nc">AuthenticationFilter</span> <span class="k">extends</span> <span class="nc">ScalatraFilter</span> <span class="o">{</span>
    <span class="n">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isProtectedUrl</span> <span class="o">&amp;&amp;</span> <span class="n">userIsNotAuthenticated</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">redirect</span><span class="o">(</span><span class="s">&quot;/signin?originalUri=&quot;</span> <span class="o">+</span> <span class="n">originalURL</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">originalURL</span><span class="o">()</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">getRequestURI</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;/main&quot;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">))</span> <span class="s">&quot;/main&quot;</span> <span class="k">else</span> <span class="n">url</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">userIsNotAuthenticated</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="o">.</span><span class="n">getAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">isProtectedUrl</span><span class="o">()</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getRequestURI</span><span class="o">();</span>
        <span class="o">!(</span><span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/authorise&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/not-authorised&quot;</span><span class="o">))</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>


<p>For more information about filters, check the <a href="http://www.scalatra.org/">Scalatra</a> documentation.</p>

<h4>signin.jade</h4>

<p>Then we need a sign-in page, that is displayed when the user is not authenticated.</p>

<div class="highlight"><pre><code class="jade"><span class="p">-</span> <span class="n">attributes</span><span class="o">(</span><span class="s">&quot;title&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="s">&quot;Cerebro&quot;</span>
<span class="p">-</span> <span class="n">attributes</span><span class="o">(</span><span class="s">&quot;layout&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="s">&quot;/WEB-INF/templates/layouts/no-header.jade&quot;</span>

<span class="p">-@ </span><span class="k">val</span> <span class="n">originalUri</span><span class="k">:</span> <span class="kt">String</span>

<span class="nt">h1</span> Welcome to Cerebro!

<span class="nt">p</span><span class="p">=</span> <span class="s">&quot;Please sigin in using google id!&quot;</span>
<span class="nt">p</span> URI: <span class="si">#{</span><span class="n">originalUri</span><span class="si">}</span>

<span class="nd">:!javascript</span>
    <span class="nd">function onSignInCallback(authResult) {</span>
        <span class="nd">if (authResult[&#39;access_token&#39;]) {</span>
            <span class="nd">$.ajax({</span>
                <span class="nd">type: &#39;POST&#39;,</span>
                <span class="nd">url: &#39;/authorise&#39;,</span>
                <span class="nd">contentType: &#39;application/x-www-form-urlencoded; charset=utf-8&#39;,</span>
                <span class="nd">data: {authCode: authResult.code },</span>
                <span class="nd">success: function(result) {</span>
                    <span class="nd">window.location.replace(&#39;</span><span class="si">#{</span><span class="n">originalUri</span><span class="si">}</span><span class="nd">&#39;);</span>
                <span class="nd">},</span>
                <span class="nd">error: function(result) {</span>
                    <span class="nd">window.location.replace(&#39;/not-authorised&#39;);</span>
                <span class="nd">}</span>
            <span class="nd">});</span>
        <span class="nd">}</span>
    <span class="nd">}</span>

<span class="nf">#gConnect</span>
    <span class="nt">button</span>(<span class="na">class=</span><span class="s">&#39;g-signin&#39;</span>
    <span class="na">data-scope=</span><span class="s">&#39;https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email&#39;</span>
    <span class="na">data-requestvisibleactions=</span><span class="s">&#39;http://schemas.google.com/AddActivity&#39;</span>
    <span class="na">data-clientId=</span><span class="s">&#39;&lt;&lt;YOUR_CLIENT_ID&gt;&gt;&#39;</span>
    <span class="na">data-accesstype=</span><span class="s">&#39;offline&#39;</span> <span class="na">data-callback=</span><span class="s">&#39;onSignInCallback&#39;</span>
    <span class="na">data-theme=</span><span class="s">&#39;dark&#39;</span>
    <span class="na">data-cookiepolicy=</span><span class="s">&#39;single_host_origin&#39;</span>)

<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://plus.google.com/js/client:plusone.js&#39;</span>)
<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&#39;</span>)
</code></pre></div>


<p>If you are not using Jade or want more details, check the <a href="https://developers.google.com/+/web/signin/add-button">official documentation</a> about how to <a href="https://developers.google.com/+/web/signin/add-button">add the sign-in button</a> to your page.</p>

<p>This should be enough to trigger the Google authentication form when clicking on the Sign-In button. Once the authentication is done, the callback function will send us a POST with the "authCode".</p>

<h4>Main Controller</h4>

<p>We then need a controller that will respond to all these requests, displays the respective pages, and do the authorisation.</p>

<div class="highlight"><pre><code class="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.controllers</span>

<span class="k">import</span> <span class="nn">javax.servlet.http.</span><span class="o">{</span><span class="nc">HttpServletResponse</span><span class="o">,</span> <span class="nc">HttpServletRequest</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">BaseController</span> <span class="k">extends</span> <span class="nc">CerebroStack</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">display</span><span class="o">(</span><span class="n">page</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">attributes</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Any</span><span class="o">)*)(</span><span class="k">implicit</span> <span class="n">request</span><span class="k">:</span> <span class="kt">HttpServletRequest</span><span class="o">,</span> <span class="n">response</span><span class="k">:</span> <span class="kt">HttpServletResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">contentType</span> <span class="k">=</span> <span class="s">&quot;text/html&quot;</span>
        <span class="k">val</span> <span class="n">all_attributes</span> <span class="k">=</span> <span class="n">attributes</span> <span class="o">:+</span> <span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">session</span><span class="o">.</span><span class="n">getAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">))</span>
        <span class="n">jade</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">all_attributes</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>




<div class="highlight"><pre><code class="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.controllers</span>

<span class="k">import</span> <span class="nn">com.codurance.cerebro.security.CoduranceAuthorisation.authorise</span>

<span class="k">import</span> <span class="nn">scala.Predef._</span>

<span class="k">class</span> <span class="nc">MainController</span> <span class="k">extends</span> <span class="nc">BaseController</span> <span class="o">{</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/main&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;signin&quot;</span><span class="o">,</span> <span class="s">&quot;originalUri&quot;</span> <span class="o">-&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="o">(</span><span class="s">&quot;originalUri&quot;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/not-authorised&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;not-authorised&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">post</span><span class="o">(</span><span class="s">&quot;/authorise&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;authCode&quot;</span><span class="o">,</span> <span class="n">halt</span><span class="o">(</span><span class="mi">400</span><span class="o">))</span>
        <span class="n">authorise</span><span class="o">(</span><span class="n">authCode</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>


<p>The MainController responds to "/authorise", which invokes the authorisation function defined inside CoduranceAuthorisation. Note that we receive the "authCode" from the Google+ authentication. Once the user was authenticated, we had to make the application available just for users using a Codurance email. For that, we had to invoke the <a href="https://developers.google.com/+/api/latest/people">Google+ People API</a> to get more information (email address, domain, etc).</p>

<p>The authorise function would then check if the user belongs to the Codurance domain and add her to the session.</p>

<div class="highlight"><pre><code class="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.security</span>

<span class="k">import</span> <span class="nn">java.net.URL</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.</span><span class="o">{</span><span class="nc">HttpSession</span><span class="o">,</span> <span class="nc">HttpServletResponse</span><span class="o">,</span> <span class="nc">HttpServletRequest</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.HttpServletResponse._</span>

<span class="k">import</span> <span class="nn">com.google.api.client.googleapis.auth.oauth2.</span><span class="o">{</span><span class="nc">GoogleAuthorizationCodeTokenRequest</span><span class="o">,</span> <span class="nc">GoogleTokenResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.google.api.client.http.javanet.NetHttpTransport</span>
<span class="k">import</span> <span class="nn">com.google.api.client.json.jackson.JacksonFactory</span>
<span class="k">import</span> <span class="nn">com.stackmob.newman._</span>
<span class="k">import</span> <span class="nn">com.stackmob.newman.dsl._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.Await</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">CoduranceAuthorisation</span> <span class="o">{</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="n">httpClient</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ApacheHttpClient</span>

    <span class="k">val</span> <span class="nc">GOOGLE_PLUS_PEOPLE_URL</span> <span class="k">=</span> <span class="s">&quot;https://www.googleapis.com/plus/v1/people/me?fields=aboutMe%2Ccover%2FcoverPhoto%2CdisplayName%2Cdomain%2Cemails%2Clanguage%2Cname&amp;access_token=&quot;</span>
    <span class="k">val</span> <span class="nc">CLIENT_ID</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;&lt;&lt;YOUR_CLIENT_ID&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">CLIENT_SECRET</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_CLIENT_SECRET&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">API_KEY</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_API_KEY&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">APPLICATION_NAME</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_APP_NAME&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">JSON_FACTORY</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JacksonFactory</span><span class="o">()</span>
    <span class="k">val</span> <span class="nc">TRANSPORT</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NetHttpTransport</span><span class="o">()</span>

    <span class="k">def</span> <span class="n">authorise</span><span class="o">(</span><span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">session</span><span class="k">:</span> <span class="kt">HttpSession</span><span class="o">,</span> <span class="n">response</span><span class="k">:</span> <span class="kt">HttpServletResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">user</span> <span class="k">=</span> <span class="n">userFor</span><span class="o">(</span><span class="n">authCode</span><span class="o">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">domain</span> <span class="k">match</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">Domain</span><span class="o">(</span><span class="s">&quot;codurance.com&quot;</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">session</span><span class="o">.</span><span class="n">setAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">setStatus</span><span class="o">(</span><span class="nc">SC_OK</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">setStatus</span><span class="o">(</span><span class="nc">SC_UNAUTHORIZED</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">userFor</span><span class="o">(</span><span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">tokenResponse</span><span class="k">:</span> <span class="kt">GoogleTokenResponse</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">GoogleAuthorizationCodeTokenRequest</span><span class="o">(</span>
                <span class="nc">TRANSPORT</span><span class="o">,</span> <span class="nc">JSON_FACTORY</span><span class="o">,</span> <span class="nc">CLIENT_ID</span><span class="o">,</span> <span class="nc">CLIENT_SECRET</span><span class="o">,</span> <span class="n">authCode</span><span class="o">,</span> <span class="s">&quot;postmessage&quot;</span>
            <span class="o">).</span><span class="n">execute</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="nc">GOOGLE_PLUS_PEOPLE_URL</span> <span class="o">+</span> <span class="n">tokenResponse</span><span class="o">.</span><span class="n">getAccessToken</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">userInfo</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="nc">GET</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="n">apply</span><span class="o">,</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span>
        <span class="nc">GooglePlusJSONResponseParser</span><span class="o">.</span><span class="n">toUser</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="n">bodyString</span><span class="o">,</span> <span class="n">tokenResponse</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>


<p><strong>Note</strong> that in the GOOGLE_PLUS_PEOPLE_URL we specify all the fields we are interested in, including the <em>domain</em> and <em>emails</em>.</p>

<p><strong>GooglePlusJSONResponseParser</strong> is a class that we created to parse the JSON response and convert into a User object. We are not showing it in order to keep this post short and focused. You can create your own JSON parser. :)</p>

<p><strong>IMPORTANT:</strong> Don't forget to import add the Google+ APIs to your sbt build file.</p>

<div class="highlight"><pre><code class="scala">    <span class="s">&quot;com.google.apis&quot;</span> <span class="o">%</span> <span class="s">&quot;google-api-services-oauth2&quot;</span> <span class="o">%</span> <span class="s">&quot;v2-rev59-1.17.0-rc&quot;</span><span class="o">,</span>
    <span class="s">&quot;com.google.apis&quot;</span> <span class="o">%</span> <span class="s">&quot;google-api-services-plus&quot;</span> <span class="o">%</span> <span class="s">&quot;v1-rev115-1.17.0-rc&quot;</span><span class="o">,</span>
</code></pre></div>


<p>That's about it. You now can display the name of the user on all your pages, using a default layout.</p>

<div class="highlight"><pre><code class="scala"><span class="o">-@</span> <span class="k">val</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">headline</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">title</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">body</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">user</span><span class="k">:</span> <span class="kt">com.codurance.cerebro.security.User</span>

<span class="o">!!!</span>
<span class="n">html</span>
    <span class="n">head</span>
        <span class="n">title</span><span class="k">=</span> <span class="n">title</span>
    <span class="n">body</span>
        <span class="n">header</span>
            <span class="n">div</span>
                <span class="n">span</span> <span class="nc">Hello</span> <span class="o">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">displayName</span><span class="o">}</span>
        <span class="n">div</span>
            <span class="n">h1</span><span class="k">=</span> <span class="n">headline</span>
            <span class="o">!=</span> <span class="n">body</span>
</code></pre></div>





        
    </div>
    <!--End Blog Post-->
</div>
<!-- End Left Sidebar -->

<!-- Right Sidebar -->
<div class="col-md-3 magazine-page">
    <!-- Blog Latest Tweets -->
    <div class="blog-twitter margin-bottom-30">
        <a class="twitter-timeline" href="https://twitter.com/mashooq/codurance" data-widget-id="400789734676385792">Tweets from Codurance team</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
    <!-- End Blog Latest Tweets -->
</div>
<!-- End Right Sidebar -->
</div>
<!--/row-->
</div>
<!--/container-->


<!--=== Copyright ===-->
<div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p class="copyright-space">
                    2013 &copy; Codurance LTD.
                     | Company Registration No: 8712584
                     | Contact us: <a href="mailto:hello@codurance.com" class="">hello@codurance.com</a>
                </p>

            </div>
            <div class="col-md-6">
                <ul class="social-icons pull-right">
                    <li><a href="/atom.xml" data-original-title="Feed" class="social_rss"></a></li>
                    <li><a href="http://twitter.com/codurance" data-original-title="Twitter" class="social_twitter"></a></li>
                </ul>
            </div>
        </div> <!--/row-->
    </div> <!--/container-->
</div><!--/copyright-->

<!--=== End Copyright ===-->

<!-- JS Global Compulsory -->
<script type="text/javascript" src="/assets/plugins/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/hover-dropdown.min.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="/assets/plugins/flexslider/jquery.flexslider-min.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/modernizr.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/jquery.cslider.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
        App.initSliders();
        Index.initParallaxSlider();
    });
</script>
<!--[if lt IE 9]>
    <script src="/assets/plugins/respond.js"></script>
<![endif]-->

</body>
</html>
